---
title: "Lab-grades"
author: "Paula de Miguel Sánchez"
format: html
---

Link to my GitHub Repository: https://github.com/paulademiguel/lab-grades.git

```{r}
here::i_am("lab-grades.Rproj")

library(here)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(knitr)
```

### Question 1

```{r}
courses <- read_csv(here("courses.csv"))
```

### Question 2

```{r}
courses |>
  arrange(course) |>
  rename(
    `Course name`     = course,
    identifier        = course_id,
    `number of grades` = nb_grades
  ) |>
  knitr::kable()
```
### Question 3
```{r}
students <- read_csv(here("students.csv"))
students <- students |>
  mutate(
    birth_date = as.Date(birth_date),
    sex= factor(sex),
    group = factor(group),
    id = as.integer(id)
  )
class(students$birth_date)
class(students$sex)
class(students$group)
class(students$id)
```
The `birth_date` column of the `students`data frame is of class Date

The `sex`column is correctly identified as a factor

### Question 4
```{r}
grades <- read_delim(
  here("grades.csv"),
  delim = "|",
  na = "unknown"
)
```
### Question 5
```{r}
students |>
  count(group) |>
  ggplot(aes(x=group, y = n)) +
  geom_col(fill = "lavenderblush2") +
  theme_minimal() +
  labs(
    title = "Number of students per group", 
    x = "Group",
    y = "Count"
  )
```
The bar plot shows the number of students that are in each group

### Question 6
```{r}
students |>
  ggplot(aes(x = group, fill = sex)) +
  geom_bar(position = "fill") +
  theme_minimal() +
  labs(
    title = "Gender balance by group",
    x = "Group",
    y = "Proportion"
  )
```
### Question 7
```{r}
students <- students |>
  mutate(
    age = time_length(today() - birth_date, unit = "year") |> round() 
    )
students |>
  ggplot(aes(x=age)) +
  geom_histogram(binwidth=1, fill = "orchid4", color = "white") +
  theme_minimal() +
  labs(
    title = "Distribution of students ages", 
    x = "Age",
    y= "Count"
  )
  
```

The histogram below displays the age distribution of the students

### Question 8
```{r}
students |>
  group_by(group) |>
  summarise(
    median_age = round(median(age, na.rm = TRUE))
  ) |>
   knitr::kable()
```

### Question 9
```{r}
students |>
  group_by(group) |>
  slice_max(order_by = age, n= 1) |>
  select(id, sex, age, group) |>
  arrange(desc(age)) |>
  knitr:: kable()
  
```

### Question 10
```{r}
n_grades <-grades |>
  filter(!is.na(grade))|>
  nrow()
n_grades
```
The data set contains 43882 grades

```{r}
courses |>
  arrange(course) |>
  knitr::kable()
```
I just did this because the merge dataset (avg_by_group) I just created was empty and I didn't understand why until I realised that maybe I was not naming properly the courses, so I did it to know the accurate names.

### Question 11
```{r}
necromancy_id <- courses |>
  filter(course == "Necromancy and Spirit Summoning") |>
  pull(course_id)

necromancy_id

grades_necro <- grades |>
  filter(course_id == necromancy_id) |>
  inner_join(students, by = "id")

avg_by_group <- grades_necro |>
  summarise(
    avg_grade = mean(grade, na.rm = TRUE),
    .by = group
  )
avg_by_group |>
  ggplot(aes(x = group, y = avg_grade)) +
  geom_col(fill = "olivedrab") +
  theme_minimal() +
  labs(
    title = "Average grade in Necromancy and  Spirit Summoning by group",
   x = "Group",
    y = "Average grade"
  )
```
### Question 12
```{r}
grades_mod <- grades |>
  inner_join(courses, by = "course_id")
grades_mod |>
  ggplot(aes(x = factor(module), y = grade)) +
  geom_boxplot(fill = "lightskyblue1") +
  theme_minimal() +
  labs(
    title = "Distribution of grades by module",
    x = "Module",
    y = "Grade"
  )
```
### Question 13
```{r}
grades_per_student <- grades |>
  summarise(
    n_grades = n(),
    .by = id
  ) |>
  inner_join(students, by = "id") |>
  select(id, group, sex, n_grades)

grades_per_student |>
  slice_head(n = 10) |>
  knitr::kable()

summary_table <- grades_per_student |>
  summarise(
    min_grades = min(n_grades),
    max_grades = max(n_grades),
    avg_grades = mean(n_grades),
    median_grades = median(n_grades)
  )
summary_table
```

The table below gives the minimum, maximum, average and median number of grades per student.

###   Question 14
```{r}
grades_per_student |>
  ggplot(aes(x = n_grades, fill = sex)) +
  geom_histogram(position = "identity", alpha = 0.6, binwidth = 1) +
  theme_minimal()
 labs(
    title = "Distribution of number of grades by sex",
    x = "Sex",
    y = "Number of grades"
  )
```
The histogram below compares the distribution of the number of grades for female and male students.

### Question 15
```{r}
elem_id <- courses |>
  filter(course == "Elemental Mastery and Control") |>
  pull(course_id)

elem_id

elem_grades <- grades |>
  filter(course_id == elem_id)

elem_counts <- elem_grades |>
  summarise(
    n_elem = n(),
    .by = id
  )

elem_counts <- elem_counts |>
  inner_join(students, by = "id") |>
  select(id, group, sex, n_elem)

elem_counts |>
  slice_head(n = 10) |>
  knitr::kable()
```
The table below shows an extract of the number of grades obtained by each student in Elemental Mastery and Control.

### Question 16
```{r}
elem_distribution <- elem_counts |>
  summarise(
    n_students = n(),
    .by = n_elem
  )
elem_distribution |>
  ggplot(aes(x = n_elem, y = n_students)) +
  geom_col(fill = "indianred3") +
  theme_minimal() +
  labs(
    title = "Distribution of number of grades in Elemental Mastery and Control",
    x = "Number of grades",
    y = "Number of students"
  )
```
The bar plot below displays the distribution of the number of grades obtained in Elemental Mastery and Control.

For each possible number of grades, it shows how many students have exactly that number.

### Question 17
```{r}
elem_counts |>
  ggplot(aes(x = group, y = n_elem)) +
  geom_col(fill = "cornflowerblue") +
  theme_minimal() +
  labs(
    title = "Number of grades in Elemental Mastery and Control by group",
    x = "Group",
    y = "Number of grades"
  )
```
The graphic below compares the number of grades obtained in Elemental Mastery and Control across groups.
This visualisation can be used to assess whether the number of grades depends on the group.

### Question 18
```{r}
elem_summary <- elem_counts |>
  summarise(
    avg_elem = mean(n_elem),
    .by = c(group, sex)
  )
elem_summary |>
  ggplot(aes(x = group, y = avg_elem)) +
  geom_col(fill = "steelblue") +
  facet_wrap(~ sex) +
  theme_minimal()
```
### Question 19
```{r}
grades_avg <- grades |>
  inner_join(students, by = "id") |>
  inner_join(courses, by = "course_id") |>
  summarise(
    avg_grade = mean(grade, na.rm = TRUE),
    .by = c(id, group, course)
  )
grades_wide <- grades_avg |>
  pivot_wider(
    id_cols = c(id, group),
    names_from = course,
    values_from = avg_grade
  )
grades_wide |>
  select(
    id,
    group,
    `Ancient Magic and Mysticism`,
    `Celestial Navigation and Astronomy`
  ) |>
  slice_head(n = 5) |>
  knitr::kable()
```
The table below shows an extract of the average grades per student and per course.

### Question 20

```{r}
grades_wide |>
  ggplot(aes(
    x = `Celestial Navigation and Astronomy`,
    y = `Dragon Lore and Taming`
  )) +
  geom_point(alpha = 0.7, color = "cyan4") +
  theme_minimal() +
  labs(
    title = "Dragon Lore and Taming vs Celestial Navigation and Astronomy",
    x = "Average grade in Celestial Navigation and Astronomy",
    y = "Average grade in Dragon Lore and Taming"
  )
```
The scatter plot below displays the relationship between the average grades in `Dragon Lore and Taming` and `Celestial Navigation and Astronomy`.  

### Question 21

```{r}
correlations <- grades_wide |>
  summarise(
    correlation = cor(
      `History of the Arcane`,
      `Celestial Navigation and Astronomy`,
      use = "complete.obs"
    ),
    .by = group
  )

correlations |>
  knitr::kable()
```

The table below reports the correlation between the average grades in `History of the Arcane` and `Celestial Navigation and Astronomy` for each group.

Question 22
```{r}
best_group <- correlations |>
  mutate(abs_cor = abs(correlation)) |>
  slice_max(order_by = abs_cor, n = 1) |>
  pull(group)

best_group

best_students <- grades_wide |>
  filter(group == best_group)

best_students |>
  ggplot(aes(
    x = `Celestial Navigation and Astronomy`,
    y = `History of the Arcane`
  )) +
  geom_point(alpha = 0.7, color = "darkmagenta") +
  theme_minimal() +
  labs(
    title = paste(
      "History of the Arcane vs Celestial Navigation and Astronomy — Group", 
      best_group
    ),
    x = "Average grade in Celestial Navigation and Astronomy",
    y = "Average grade in History of the Arcane"
  )
```

The plot below shows the relationship between the average grades in `History of the Arcane`and `Celestial Navigation and Astronomy` for the group where these grades are the most correlated.

### Question 23
```{r}
grades_wide2 <- grades_wide |>
  inner_join(students |> select(id, sex), by = "id")

final_grades <- grades_wide2 |>
  rowwise() |>
  mutate(
    final_grade = mean(c_across(-c(id, group, sex)), na.rm = TRUE)
  ) |>
  ungroup()

final_grades_df <- final_grades |>
  select(id, group, sex, final_grade) |>
  arrange(desc(final_grade))

final_grades_df |>
  slice_head(n = 5) |>
  knitr::kable()
```
The final grade of a student is defined as the average of their average grades across all courses.

The table below displays the top five students according to this metric.




